name: ðŸŽ Self-Hosted CI (M4 Optimized)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      runner_type:
        description: 'Runner type to use'
        required: true
        type: choice
        options:
          - self-hosted
          - ubuntu-latest
        default: self-hosted

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # Job to test runner availability
  runner-check:
    name: ðŸ” Check Runner
    runs-on: ${{ github.event.inputs.runner_type || 'self-hosted' }}
    timeout-minutes: 5
    outputs:
      runner_available: ${{ steps.check.outputs.available }}

    steps:
      - name: ðŸƒ Check Runner Status
        id: check
        run: |
          echo "ðŸŽ Running on: $(uname -a)"
          echo "ðŸ“Š Processor: $(sysctl -n machdep.cpu.brand_string || echo 'Unknown')"
          echo "ðŸ’¾ Memory: $(sysctl -n hw.memsize | awk '{print $1/1024/1024/1024 " GB"}' || echo 'Unknown')"
          echo "available=true" >> $GITHUB_OUTPUT

      - name: ðŸ”§ Check Tools
        run: |
          echo "Node: $(node --version || echo 'Not installed')"
          echo "NPM: $(npm --version || echo 'Not installed')"
          echo "PNPM: $(pnpm --version || echo 'Not installed')"
          echo "Git: $(git --version)"
          echo "Docker: $(docker --version || echo 'Not installed')"

  # Main CI job optimized for M4
  ci-m4-optimized:
    name: ðŸš€ CI Build (M4 Optimized)
    needs: runner-check
    if: needs.runner-check.outputs.runner_available == 'true'
    runs-on: ${{ github.event.inputs.runner_type || 'self-hosted' }}
    timeout-minutes: 30

    strategy:
      matrix:
        include:
          - name: "Build & Test"
            cache-key: "m4-build"
          - name: "Lint & Type Check"
            cache-key: "m4-lint"

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      # M4-optimized cache
      - name: ðŸ’¾ Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-m4-pnpm-store-${{ matrix.cache-key }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-m4-pnpm-store-${{ matrix.cache-key }}-
            ${{ runner.os }}-m4-pnpm-store-

      - name: ðŸ“¥ Install dependencies
        run: |
          # M4-optimized installation
          export NODE_OPTIONS="--max-old-space-size=8192"
          pnpm install --frozen-lockfile --prefer-offline

      - name: ðŸ—ï¸ Build
        if: matrix.name == 'Build & Test'
        run: |
          # M4-optimized build with parallel processing
          export NODE_OPTIONS="--max-old-space-size=8192"
          export JOBS=8  # M4 has 8 performance cores
          pnpm run build --parallel

      - name: ðŸ§ª Run Tests
        if: matrix.name == 'Build & Test'
        run: |
          export NODE_OPTIONS="--max-old-space-size=8192"
          pnpm run test --parallel

      - name: ðŸ” Run Linting
        if: matrix.name == 'Lint & Type Check'
        run: |
          pnpm run lint --parallel

      - name: ðŸ“Š Type Check
        if: matrix.name == 'Lint & Type Check'
        run: |
          pnpm run typecheck --parallel

      - name: ðŸ“ˆ Performance Metrics
        if: always()
        run: |
          echo "### Performance Metrics ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Runner | ${{ runner.name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| OS | ${{ runner.os }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Arch | ${{ runner.arch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Job Duration | ${{ job.duration }}ms |" >> $GITHUB_STEP_SUMMARY

  # Fallback to GitHub-hosted runners
  ci-fallback:
    name: ðŸ”„ CI Fallback (GitHub Hosted)
    needs: runner-check
    if: |
      always() &&
      (needs.runner-check.result == 'failure' ||
       needs.runner-check.result == 'skipped' ||
       github.event.inputs.runner_type == 'ubuntu-latest')
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build
        run: pnpm run build

      - name: ðŸ§ª Test
        run: pnpm run test

      - name: ðŸ” Lint
        run: pnpm run lint

  # Special job for heavy workloads
  heavy-workload:
    name: ðŸ‹ï¸ Heavy Workload (M4 Only)
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.runner_type == 'self-hosted'
    runs-on: [self-hosted, M4]
    timeout-minutes: 60

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Environment
        run: |
          echo "Setting up M4-optimized environment..."
          export NODE_OPTIONS="--max-old-space-size=16384"
          export UV_THREADPOOL_SIZE=16

      - name: ðŸ—ï¸ Full Build
        run: |
          pnpm install
          pnpm run build:all

      - name: ðŸ“Š Bundle Analysis
        run: |
          pnpm run analyze || echo "Bundle analysis not configured"

      - name: ðŸ§ª E2E Tests
        run: |
          pnpm run test:e2e || echo "E2E tests not configured"

      - name: ðŸ“ˆ Generate Reports
        run: |
          echo "### Heavy Workload Report ðŸ‹ï¸" >> $GITHUB_STEP_SUMMARY
          echo "Successfully processed on M4 runner" >> $GITHUB_STEP_SUMMARY

  # Status reporting
  status:
    name: ðŸ“Š Status Report
    if: always()
    needs: [ci-m4-optimized, ci-fallback]
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“ˆ Report Status
        run: |
          echo "### CI Status Report ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ needs.ci-m4-optimized.result }}" == "success" ]]; then
            echo "âœ… **M4 Runner**: Success" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.ci-m4-optimized.result }}" == "skipped" ]]; then
            echo "â­ï¸ **M4 Runner**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **M4 Runner**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [[ "${{ needs.ci-fallback.result }}" == "success" ]]; then
            echo "âœ… **Fallback Runner**: Success" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.ci-fallback.result }}" == "skipped" ]]; then
            echo "â­ï¸ **Fallback Runner**: Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Fallback Runner**: Failed" >> $GITHUB_STEP_SUMMARY
          fi